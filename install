#!/bin/sh
set -eu

# ====== FIXED GITHUB ======
ORG="SkyNextGen"
REPO="kvas-sync"
BRANCH="main"
RAW_BASE="https://raw.githubusercontent.com/${ORG}/${REPO}/${BRANCH}"

# ====== PATHS ======
INSTALL_DIR="/opt/kvas-sync"
CONF_DIR="${INSTALL_DIR}/conf"
SECRETS_FILE="${CONF_DIR}/secrets.conf"
DEVICE_FILE="${CONF_DIR}/device.conf"

need_cmd() { command -v "$1" >/dev/null 2>&1; }

say() { echo "$*" >&2; }

install_deps() {
  say "Проверка зависимостей Entware..."

  if ! need_cmd opkg; then
    say "❌ Entware (opkg) не найден. Установите Entware."
    exit 1
  fi

  opkg update >/dev/null 2>&1 || true

  for pkg in curl ca-bundle unzip coreutils-timeout coreutils-sha256sum; do
    opkg install "$pkg" >/dev/null 2>&1 || true
  done

  if ! need_cmd curl; then
    say "❌ curl не установлен."
    exit 1
  fi
}

prompt() {
  printf "%s: " "$1"
  IFS= read -r ans || true
  printf "%s" "$ans"
}

# ====== START ======
say "Установка kvas-sync в ${INSTALL_DIR}"
install_deps

mkdir -p "$INSTALL_DIR"
mkdir -p "$CONF_DIR"

cd "$INSTALL_DIR"

say "Загрузка файлов из GitHub (${ORG}/${REPO}:${BRANCH})..."

curl -fsSLo kvas-sync.sh "${RAW_BASE}/kvas-sync.sh"
chmod +x kvas-sync.sh

# ====== TELEGRAM INPUT ======
echo ""
echo "Введите данные Telegram (они будут сохранены в conf/secrets.conf с правами 600)"

BOT_TOKEN="$(prompt "Токен бота")"
echo ""
CHAT_ID="$(prompt "ID чата")"
echo ""
ROUTER_NAME="$(prompt "Имя роутера (на русском)")"
echo ""

# ====== SAVE CONFIG ======
umask 077
cat > "$SECRETS_FILE" <<EOF
BOT_TOKEN="${BOT_TOKEN}"
CHAT_ID="${CHAT_ID}"
EOF
chmod 600 "$SECRETS_FILE"

cat > "$DEVICE_FILE" <<EOF
ROUTER_NAME="${ROUTER_NAME}"
EOF

# ====== CRON SETUP ======
CRON_LINE="15 3 * * 3 ${INSTALL_DIR}/kvas-sync.sh >> ${INSTALL_DIR}/cron.log 2>&1"

say "Настройка cron (каждую среду 03:15)..."

crontab -l 2>/dev/null | grep -v "${INSTALL_DIR}/kvas-sync.sh" > /opt/tmp/kvas_cron || true
echo "$CRON_LINE" >> /opt/tmp/kvas_cron
crontab /opt/tmp/kvas_cron
rm -f /opt/tmp/kvas_cron

# ====== TEST RUN ======
say "Пробный запуск..."
if sh "${INSTALL_DIR}/kvas-sync.sh"; then
  say "✅ Установка завершена успешно."
else
  say "⚠️ Скрипт выполнен с ошибками. Проверьте лог."
fi
