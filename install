#!/bin/sh
set -eu

# ===== FIXED GITHUB =====
ORG="SkyNextGen"
REPO="kvas-sync"
BRANCH="main"

BASE="/opt/kvas-sync"
TMP="/opt/tmp/kvas-sync-install.$$"
ARCHIVE_ZIP="/opt/tmp/kvas-sync-main.zip"

need_cmd() { command -v "$1" >/dev/null 2>&1; }
say() { echo "$*" >&2; }

ask() {
  p="$1"; d="${2:-}"
  if [ -n "$d" ]; then
    printf "%s [%s]: " "$p" "$d" >&2
  else
    printf "%s: " "$p" >&2
  fi
  IFS= read -r ans || true
  if [ -z "$ans" ] && [ -n "$d" ]; then ans="$d"; fi
  printf "%s" "$ans"
}

install_deps() {
  if ! need_cmd opkg; then
    say "❌ Entware (opkg) не найден."
    exit 1
  fi

  opkg update >/dev/null 2>&1 || true
  # unzip нужен для архива репозитория, ca-bundle чтобы curl по https не падал
  for pkg in curl ca-bundle unzip coreutils-timeout; do
    opkg install "$pkg" >/dev/null 2>&1 || true
  done

  need_cmd curl || { say "❌ Нет curl"; exit 1; }
  need_cmd unzip || { say "❌ Нет unzip"; exit 1; }
}

cleanup() {
  rm -rf "$TMP" >/dev/null 2>&1 || true
}
trap cleanup EXIT

say "Установка kvas-sync в ${BASE}"
install_deps

mkdir -p /opt/tmp
mkdir -p "$TMP"

# ===== Download GitHub auto-generated archive of branch =====
# Это не raw-файл, а стабильный zip, который GitHub генерирует сам
ARCHIVE_URL="https://codeload.github.com/${ORG}/${REPO}/zip/refs/heads/${BRANCH}"

say "Загрузка архива репозитория: ${ORG}/${REPO}@${BRANCH}"
curl -fsSLo "$ARCHIVE_ZIP" "$ARCHIVE_URL"

# защита от пустоты/HTML
[ -s "$ARCHIVE_ZIP" ] || { say "❌ Архив не скачался или пустой."; exit 1; }

# Проверка сигнатуры ZIP ("PK")
head -c 2 "$ARCHIVE_ZIP" | grep -q "PK" || {
  say "❌ Скачанное не похоже на ZIP (возможно блокировка/подмена)."
  exit 1
}

say "Распаковка архива..."
unzip -qo "$ARCHIVE_ZIP" -d "$TMP"

# Внутри будет каталог вида kvas-sync-main/
SRC_DIR="$(find "$TMP" -maxdepth 1 -type d -name "${REPO}-*" | head -n 1)"
[ -n "${SRC_DIR:-}" ] || { say "❌ Не найден каталог репозитория после распаковки."; exit 1; }

# Проверяем наличие payload
[ -d "$SRC_DIR/payload/bin" ] || { say "❌ В репозитории нет payload/bin"; exit 1; }
[ -x "$SRC_DIR/payload/bin/kvas-sync.sh" ] || chmod +x "$SRC_DIR/payload/bin/kvas-sync.sh" || true

# ===== Deploy to /opt/kvas-sync preserving your structure =====
say "Развёртывание payload -> ${BASE}"
mkdir -p "$BASE"

# bin/conf — из payload
rm -rf "$BASE/bin" "$BASE/conf"
mkdir -p "$BASE"
cp -R "$SRC_DIR/payload/bin"  "$BASE/bin"
cp -R "$SRC_DIR/payload/conf" "$BASE/conf"

chmod +x "$BASE/bin/kvas-sync.sh"

# ===== Interactive config =====
echo ""
say "Введите данные Telegram (сохраним в $BASE/conf/secrets.conf, права 600)"
BOT_TOKEN="$(ask "Токен бота" "")"
CHAT_ID="$(ask "ID чата" "")"
ROUTER_NAME="$(ask "Имя роутера (на русском)" "Keenetic-1")"

[ -n "$BOT_TOKEN" ] || { say "❌ Пустой токен."; exit 1; }
[ -n "$CHAT_ID" ] || { say "❌ Пустой chat_id."; exit 1; }
[ -n "$ROUTER_NAME" ] || { say "❌ Пустое имя роутера."; exit 1; }

umask 077
cat > "$BASE/conf/secrets.conf" <<EOF
BOT_TOKEN="$BOT_TOKEN"
CHAT_ID="$CHAT_ID"
EOF
chmod 600 "$BASE/conf/secrets.conf"

# device.conf — создаём из example (если есть), иначе минимальный
if [ -f "$BASE/conf/device.example.conf" ]; then
  # копируем example -> device.conf и подставляем имя, если есть ключ ROUTER_NAME
  cp "$BASE/conf/device.example.conf" "$BASE/conf/device.conf"
  if grep -q '^ROUTER_NAME=' "$BASE/conf/device.conf" 2>/dev/null; then
    sed -i "s/^ROUTER_NAME=.*/ROUTER_NAME=\"$ROUTER_NAME\"/" "$BASE/conf/device.conf" || true
  else
    printf '\nROUTER_NAME="%s"\n' "$ROUTER_NAME" >> "$BASE/conf/device.conf"
  fi
else
  cat > "$BASE/conf/device.conf" <<EOF
ROUTER_NAME="$ROUTER_NAME"
EOF
fi
chmod 644 "$BASE/conf/device.conf"

# ===== Ensure runtime dirs =====
mkdir -p "$BASE/log" "$BASE/state" "$BASE/tmp"

# ===== Cron (Wed 03:15 MSK) =====
CRON_LINE="15 3 * * 3 /opt/kvas-sync/bin/kvas-sync.sh >> /opt/kvas-sync/log/cron.log 2>&1"
say "Настройка cron: каждую среду 03:15"

# вы просили: при повторном запуске пусть прописывается заново как новый — делаем так:
# удаляем старые строки и добавляем новую (в итоге одна актуальная строка)
crontab -l 2>/dev/null | grep -v '/opt/kvas-sync/bin/kvas-sync.sh' > /opt/tmp/kvas_cron.tmp || true
echo "$CRON_LINE" >> /opt/tmp/kvas_cron.tmp
crontab /opt/tmp/kvas_cron.tmp
rm -f /opt/tmp/kvas_cron.tmp

# ===== Test run =====
say "Пробный запуск..."
if /opt/kvas-sync/bin/kvas-sync.sh; then
  say "✅ Установка завершена."
else
  say "⚠️ Установка завершена, но пробный запуск с ошибкой (смотрите /opt/kvas-sync/log)."
fi
