#!/bin/sh
set -eu

REPO_OWNER="SkyNextGen"
REPO_NAME="kvas-sync"
REPO_BRANCH="main"

BASE="/opt/kvas-sync"
TMPDIR="/opt/tmp"
CRON_LINE="15 3 * * 3 $BASE/bin/kvas-sync.sh >> $BASE/log/cron.log 2>&1"

# Всё печатаем в STDERR — чтобы в SSH не "пряталось"
say() { printf '%s\n' "$*" >&2; }

ask() {
  # prompt — в STDERR, ввод читаем из STDIN
  printf "%s: " "$1" >&2
  IFS= read -r v || true
  printf '%s' "$v"
}

# ------------------------------
# ВАЛИДАЦИЯ ВВОДА (байтовая)
# ------------------------------

has_replacement_char() {
  # ловим символ � (U+FFFD)
  printf '%s' "$1" | grep -q '�'
}

has_control_bytes() {
  # байтовая проверка: если после удаления control-байтов строка изменилась — значит control были
  # удаляем: 0x00-0x08, 0x0B,0x0C, 0x0E-0x1F, 0x7F
  s="$1"
  cleaned="$(printf '%s' "$s" | LC_ALL=C tr -d '\000-\010\013\014\016-\037\177')"
  [ "$cleaned" != "$s" ]
}

prompt_clean() {
  label="$1"
  while :; do
    v="$(ask "$label")"

    # Убираем CR (часто прилетает из терминалов/копипаста)
    v="$(printf '%s' "$v" | tr -d '\r')"

    if [ -z "$v" ]; then
      say "❌ Поле не может быть пустым."
      continue
    fi

    if has_replacement_char "$v" || has_control_bytes "$v"; then
      say "❌ Похоже, в вводе есть битые/недопустимые символы (например � или управляющие)."
      say "   Введите заново (рекомендуется вводить вручную, без вставки)."
      continue
    fi

    printf '%s' "$v"
    return 0
  done
}

prompt_bot_token() {
  while :; do
    t="$(prompt_clean "Токен бота")"
    echo "$t" | grep -Eq '^[0-9]+:[A-Za-z0-9_-]+$' || {
      say "❌ Токен выглядит неверно. Формат: 123456:ABCdef_-..."
      continue
    }
    printf '%s' "$t"
    return 0
  done
}

prompt_chat_id() {
  while :; do
    c="$(prompt_clean "ID чата")"
    echo "$c" | grep -Eq '^-?[0-9]+$' || {
      say "❌ ID чата должен быть числом (например 947..., либо -100...)."
      continue
    }
    printf '%s' "$c"
    return 0
  done
}

# ------------------------------
# ЗАВИСИМОСТИ
# ------------------------------

ensure_deps() {
  say "Проверка зависимостей Entware..."

  command -v opkg >/dev/null 2>&1 || {
    say "❌ Entware не установлен."
    exit 1
  }

  opkg update >/dev/null 2>&1 || true

  # curl/unzip/timeout/iconv
  opkg install curl unzip coreutils-timeout libiconv iconv >/dev/null 2>&1 || true

  command -v curl >/dev/null 2>&1 || say "⚠️ curl не найден в PATH"
  command -v unzip >/dev/null 2>&1 || say "⚠️ unzip не найден в PATH"
  command -v timeout >/dev/null 2>&1 || say "⚠️ timeout не найден в PATH"
}

# ------------------------------
# DNS FIX (для curl в Entware)
# ------------------------------

ensure_resolv() {
  mkdir -p /opt/etc
  if [ ! -f /opt/etc/resolv.conf ]; then
    echo "nameserver 127.0.0.1" > /opt/etc/resolv.conf
  fi
}

# ------------------------------
# ЗАГРУЗКА REPO (zip)
# ------------------------------

download_repo() {
  say "Загрузка архива репозитория: $REPO_OWNER/$REPO_NAME@$REPO_BRANCH"

  WORK="$TMPDIR/kvas-sync-install.$$"
  rm -rf "$WORK"
  mkdir -p "$WORK"
  cd "$WORK"

  curl -fsSL \
    "https://codeload.github.com/$REPO_OWNER/$REPO_NAME/zip/$REPO_BRANCH" \
    -o repo.zip

  unzip -q repo.zip

  PAYLOAD_DIR="$(find . -type d -name payload | head -n 1)"
  [ -n "$PAYLOAD_DIR" ] || { say "❌ payload не найден"; exit 1; }

  # защита от install-stub
  if grep -q 'cat > /opt/kvas-sync/bin/kvas-sync.sh' "$PAYLOAD_DIR/bin/kvas-sync.sh"; then
    say "❌ Ошибка: в payload/bin/kvas-sync.sh найден install-stub (cat > ...)."
    exit 1
  fi

  say "Развёртывание в $BASE ..."
  rm -rf "$BASE"
  mkdir -p "$BASE"
  cp -r "$PAYLOAD_DIR/"* "$BASE/"

  chmod +x "$BASE/bin/kvas-sync.sh"

  rm -rf "$WORK"
}

# ------------------------------
# КОНФИГИ
# ------------------------------

write_configs() {
  say ""
  say "Введите данные Telegram"

  BOT_TOKEN="$(prompt_bot_token)"
  CHAT_ID="$(prompt_chat_id)"
  ROUTER_NAME="$(prompt_clean "Введите имя роутера")"

  mkdir -p "$BASE/conf"

  cat > "$BASE/conf/secrets.conf" <<EOF
BOT_TOKEN="$BOT_TOKEN"
CHAT_ID="$CHAT_ID"
EOF
  chmod 600 "$BASE/conf/secrets.conf"

  cat > "$BASE/conf/device.conf" <<EOF
ROUTER_NAME="$ROUTER_NAME"
IMPORT_CMD="kvas import"
EOF
}

# ------------------------------
# CRON
# ------------------------------

setup_cron() {
  say "Настройка cron: каждую среду 03:15 (очистка и запись заново)"

  crontab -r 2>/dev/null || true
  printf "%s\n" "$CRON_LINE" | crontab -

  say "Запуск cron-демона..."
  /opt/etc/init.d/S10cron start 2>/dev/null || true
  /opt/sbin/crond 2>/dev/null || true
}

# ------------------------------
# ТЕСТОВЫЙ ЗАПУСК
# ------------------------------

test_run() {
  say "Пробный запуск..."

  rm -rf "$BASE/state/import.lock" 2>/dev/null || true

  INSTALL_LOG="$BASE/log/install-run.log"
  mkdir -p "$BASE/log"
  echo "===== install test run: $(date '+%Y-%m-%d %H:%M:%S') =====" >> "$INSTALL_LOG"

  "$BASE/bin/kvas-sync.sh" >>"$INSTALL_LOG" 2>&1 || true

  say "----- tail install-run.log -----"
  tail -n 200 "$INSTALL_LOG" 2>/dev/null >&2 || true
  say "--------------------------------"

  if [ -f "$BASE/log/kvas-sync.log" ]; then
    say "✅ Агент создал kvas-sync.log"
  else
    say "⚠️ Агент не создал kvas-sync.log — смотрите install-run.log"
  fi

  say "Лог пробного запуска: $INSTALL_LOG"
  say "Лог агента: $BASE/log/kvas-sync.log"
}

# ------------------------------
# MAIN
# ------------------------------

say "Установка kvas-sync в $BASE"

ensure_deps
ensure_resolv
download_repo
write_configs
setup_cron
test_run

say "✅ Установка завершена."
