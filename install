#!/bin/sh
set -eu

ORG="SkyNextGen"
REPO="kvas-sync"
BRANCH="main"

BASE="/opt/kvas-sync"
WORK="/opt/tmp/kvas-sync-install.$$"
ARCHIVE="/opt/tmp/kvas-sync-${BRANCH}.zip"

need_cmd() { command -v "$1" >/dev/null 2>&1; }
say() { echo "$*" >&2; }

ask() {
  printf "%s: " "$1" >&2
  IFS= read -r ans || true
  printf "%s" "$ans"
}

cleanup() { rm -rf "$WORK" >/dev/null 2>&1 || true; }
trap cleanup EXIT

install_deps() {
  if ! need_cmd opkg; then
    say "❌ Entware (opkg) не найден."
    exit 1
  fi

  opkg update >/dev/null 2>&1 || true

  for pkg in curl ca-bundle unzip coreutils-timeout; do
    opkg install "$pkg" >/dev/null 2>&1 || true
  done

  need_cmd curl  || { say "❌ Нет curl"; exit 1; }
  need_cmd unzip || { say "❌ Нет unzip"; exit 1; }
  need_cmd find  || { say "❌ Нет find"; exit 1; }
}

start_cron_now() {
  # 1) пробуем штатный init.d (если есть)
  if [ -x /opt/etc/init.d/S10cron ]; then
    /opt/etc/init.d/S10cron start >/dev/null 2>&1 || true
  fi

  # 2) если всё ещё не запущен — стартуем напрямую
  if ! ps | grep -q '[/]opt/sbin/crond'; then
    if [ -x /opt/sbin/crond ]; then
      /opt/sbin/crond >/dev/null 2>&1 || true
    fi
  fi
}

ensure_cron_autostart() {
  # Универсальный “якорь” автозапуска: /opt/etc/rc.local
  # (на Keenetic/Entware часто исполняется при монтировании /opt на старте)
  RC="/opt/etc/rc.local"
  MARK="# kvas-sync: ensure crond"

  mkdir -p /opt/etc

  if [ ! -f "$RC" ]; then
    cat > "$RC" <<'EOF'
#!/bin/sh
EOF
    chmod +x "$RC"
  else
    # гарантируем, что файл исполняемый
    chmod +x "$RC" >/dev/null 2>&1 || true
  fi

  # добавляем блок один раз
  if ! grep -q "$MARK" "$RC" 2>/dev/null; then
    cat >> "$RC" <<'EOF'

# kvas-sync: ensure crond
if ! ps | grep -q '[/]opt/sbin/crond'; then
  if [ -x /opt/etc/init.d/S10cron ]; then
    /opt/etc/init.d/S10cron start >/dev/null 2>&1 || true
  elif [ -x /opt/sbin/crond ]; then
    /opt/sbin/crond >/dev/null 2>&1 || true
  fi
fi
EOF
  fi
}

say "Установка kvas-sync в $BASE"
install_deps

mkdir -p /opt/tmp
mkdir -p "$WORK"

# архив через github.com (чтобы не зависеть от codeload)
ARCHIVE_URL="https://github.com/${ORG}/${REPO}/archive/refs/heads/${BRANCH}.zip"

say "Загрузка архива репозитория: ${ORG}/${REPO}@${BRANCH}"
curl -fsSLo "$ARCHIVE" "$ARCHIVE_URL"

[ -s "$ARCHIVE" ] || { say "❌ Архив не скачался или пустой"; exit 1; }
head -c 2 "$ARCHIVE" | grep -q "PK" || { say "❌ Скачанное не похоже на ZIP"; exit 1; }

say "Распаковка архива..."
unzip -qo "$ARCHIVE" -d "$WORK"

KS_PATH="$(find "$WORK" -type f -path '*/payload/bin/kvas-sync.sh' -print -quit 2>/dev/null || true)"
if [ -z "$KS_PATH" ]; then
  say "❌ Не найден payload/bin/kvas-sync.sh"
  exit 1
fi

PAYLOAD_DIR="$(dirname "$(dirname "$KS_PATH")")"

say "Найден payload: $PAYLOAD_DIR"
say "Развёртывание в $BASE ..."

mkdir -p "$BASE"
rm -rf "$BASE/bin" "$BASE/conf"
cp -R "$PAYLOAD_DIR/bin"  "$BASE/bin"
cp -R "$PAYLOAD_DIR/conf" "$BASE/conf"
chmod +x "$BASE/bin/kvas-sync.sh"

mkdir -p "$BASE/log" "$BASE/state" "$BASE/tmp"

echo ""
echo "Введите данные Telegram"

BOT_TOKEN="$(ask "Токен бота")"
[ -n "$BOT_TOKEN" ] || { say "❌ Токен не может быть пустым"; exit 1; }

CHAT_ID="$(ask "ID чата")"
[ -n "$CHAT_ID" ] || { say "❌ ID чата не может быть пустым"; exit 1; }

ROUTER_NAME="$(ask "Введите имя роутера")"
[ -n "$ROUTER_NAME" ] || { say "❌ Имя роутера не может быть пустым"; exit 1; }

umask 077
cat > "$BASE/conf/secrets.conf" <<EOF
BOT_TOKEN="$BOT_TOKEN"
CHAT_ID="$CHAT_ID"
EOF
chmod 600 "$BASE/conf/secrets.conf"

cat > "$BASE/conf/device.conf" <<EOF
ROUTER_NAME="$ROUTER_NAME"
IMPORT_CMD="kvas import"
EOF
chmod 644 "$BASE/conf/device.conf"

# cron "под 0"
CRON_LINE="15 3 * * 3 /opt/kvas-sync/bin/kvas-sync.sh >> /opt/kvas-sync/log/cron.log 2>&1"
say "Настройка cron: каждую среду 03:15 (очистка и запись заново)"
printf "%s\n" "$CRON_LINE" | crontab -

# стартуем cron сейчас + обеспечиваем автозапуск
say "Запуск cron-демона..."
start_cron_now
ensure_cron_autostart

say "Пробный запуск..."
if /opt/kvas-sync/bin/kvas-sync.sh; then
  say "✅ Установка завершена."
else
  say "⚠️ Установка завершена, но пробный запуск с ошибкой."
fi
